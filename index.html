<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="theme-color" content="#0a0a0b" />
  <title>Luna·õú Audio DAW</title>
  <link rel="manifest" href="manifest.json">
  <style>
    :root {
      --bg: #0a0a0b;
      --panel: #111114;
      --panel-light: #1a1a1e;
      --muted: #a1a1aa;
      --border: #27272a;
      --txt: #e5e7eb;
      --accent: #2563eb;
      --success: #10b981;
      --warning: #f59e0b;
      --danger: #ef4444;
    }
    
    * { box-sizing: border-box; }
    html, body { height: 100%; margin: 0; overflow: hidden; }
    
    body {
      background: var(--bg);
      color: var(--txt);
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      display: flex;
      flex-direction: column;
    }
    
    .toolbar {
      background: var(--panel);
      border-bottom: 1px solid var(--border);
      padding: 8px 12px;
      display: flex;
      align-items: center;
      gap: 8px;
      flex-shrink: 0;
    }
    
    .toolbar-section {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 0 8px;
      border-right: 1px solid var(--border);
    }
    
    .toolbar-section:last-child { border-right: none; }
    
    .logo {
      font-size: 16px;
      font-weight: 700;
      background: linear-gradient(135deg, #2563eb, #7c3aed);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      margin-right: 8px;
    }
    
    .icon-btn {
      background: transparent;
      border: 1px solid var(--border);
      color: var(--txt);
      padding: 6px 10px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 13px;
      display: flex;
      align-items: center;
      gap: 4px;
      transition: all 0.2s;
    }
    
    .icon-btn:hover:not(:disabled) {
      background: var(--panel-light);
      border-color: var(--accent);
    }
    
    .icon-btn:disabled {
      opacity: 0.4;
      cursor: not-allowed;
    }
    
    .icon-btn.primary {
      background: var(--accent);
      border-color: var(--accent);
      color: white;
    }
    
    .icon-btn.primary:hover:not(:disabled) {
      background: #1d4ed8;
    }
    
    .icon-btn.success {
      background: var(--success);
      border-color: var(--success);
      color: white;
    }
    
    .main-container {
      display: flex;
      flex: 1;
      overflow: hidden;
    }
    
    .sidebar {
      width: 280px;
      background: var(--panel);
      border-right: 1px solid var(--border);
      overflow-y: auto;
      flex-shrink: 0;
    }
    
    .panel-section {
      border-bottom: 1px solid var(--border);
    }
    
    .panel-header {
      padding: 10px 12px;
      background: var(--panel-light);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: space-between;
      font-size: 13px;
      font-weight: 600;
      user-select: none;
    }
    
    .panel-header:hover {
      background: #222226;
    }
    
    .panel-content {
      padding: 12px;
      display: none;
    }
    
    .panel-content.active {
      display: block;
    }
    
    .chevron {
      transition: transform 0.2s;
    }
    
    .chevron.open {
      transform: rotate(90deg);
    }
    
    .workspace {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    
    .upload-area {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 40px;
    }
    
    .upload-box {
      text-align: center;
      padding: 60px;
      border: 2px dashed var(--border);
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.3s;
    }
    
    .upload-box:hover {
      border-color: var(--accent);
      background: rgba(37, 99, 235, 0.05);
    }
    
    .upload-icon {
      font-size: 48px;
      margin-bottom: 16px;
    }
    
    .editor-area {
      flex: 1;
      display: none;
      flex-direction: column;
      padding: 16px;
      overflow-y: auto;
    }
    
    .editor-area.active {
      display: flex;
    }
    
    .waveform-container {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 16px;
      margin-bottom: 16px;
    }
    
    .waveform-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }
    
    .waveform-canvas {
      width: 100%;
      height: 120px;
      background: #0a0a0b;
      border-radius: 6px;
      cursor: pointer;
      position: relative;
    }
    
    canvas {
      display: block;
      width: 100%;
      height: 100%;
    }
    
    .transport {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 16px;
      display: flex;
      align-items: center;
      gap: 12px;
    }
    
    .transport-btn {
      background: var(--panel-light);
      border: 1px solid var(--border);
      color: var(--txt);
      width: 40px;
      height: 40px;
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
      transition: all 0.2s;
    }
    
    .transport-btn:hover:not(:disabled) {
      background: var(--accent);
      border-color: var(--accent);
      transform: scale(1.05);
    }
    
    .transport-btn.play {
      width: 50px;
      height: 50px;
      background: var(--accent);
      border-color: var(--accent);
    }
    
    .transport-btn:disabled {
      opacity: 0.3;
      cursor: not-allowed;
    }
    
    .time-display {
      font-family: 'Courier New', monospace;
      font-size: 16px;
      color: var(--muted);
      min-width: 120px;
    }
    
    .form-group {
      margin-bottom: 14px;
    }
    
    .form-label {
      display: block;
      font-size: 12px;
      font-weight: 500;
      margin-bottom: 6px;
      color: var(--muted);
    }
    
    .form-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 6px;
    }
    
    input[type="range"] {
      width: 100%;
      height: 6px;
      border-radius: 3px;
      background: var(--border);
      outline: none;
      -webkit-appearance: none;
    }
    
    input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 16px;
      height: 16px;
      border-radius: 50%;
      background: var(--accent);
      cursor: pointer;
    }
    
    input[type="range"]::-moz-range-thumb {
      width: 16px;
      height: 16px;
      border-radius: 50%;
      background: var(--accent);
      cursor: pointer;
      border: none;
    }
    
    .preset-btns {
      display: flex;
      gap: 4px;
      flex-wrap: wrap;
      margin-top: 6px;
    }
    
    .preset-btn {
      background: var(--panel-light);
      border: 1px solid var(--border);
      color: var(--txt);
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 11px;
      cursor: pointer;
    }
    
    .preset-btn:hover {
      background: var(--accent);
      border-color: var(--accent);
    }
    
    .info-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
      font-size: 12px;
    }
    
    .info-item {
      background: var(--panel-light);
      padding: 8px;
      border-radius: 4px;
    }
    
    .info-label {
      color: var(--muted);
      font-size: 10px;
      text-transform: uppercase;
      margin-bottom: 2px;
    }
    
    .info-value {
      font-weight: 600;
      font-size: 14px;
      color: var(--accent);
    }
    
    .checkbox-group {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px;
      background: var(--panel-light);
      border-radius: 4px;
      font-size: 12px;
    }
    
    input[type="checkbox"] {
      width: 16px;
      height: 16px;
      cursor: pointer;
    }
    
    .spinner {
      display: inline-block;
      width: 14px;
      height: 14px;
      border: 2px solid var(--border);
      border-top-color: var(--accent);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    .status-bar {
      background: var(--panel);
      border-top: 1px solid var(--border);
      padding: 6px 12px;
      font-size: 12px;
      color: var(--muted);
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .badge {
      background: var(--accent);
      color: white;
      padding: 2px 6px;
      border-radius: 4px;
      font-size: 10px;
      font-weight: 600;
    }
    
    input[type="file"] {
      display: none;
    }
    
    @media (max-width: 768px) {
      .sidebar {
        width: 100%;
        max-height: 40vh;
        border-right: none;
        border-bottom: 1px solid var(--border);
      }
      
      .main-container {
        flex-direction: column;
      }
    }
  </style>
</head>
<body>
  <div class="toolbar">
    <div class="logo">Luna·õú DAW</div>
    
    <div class="toolbar-section">
      <button class="icon-btn" id="openFileBtn">üìÅ Abrir</button>
      <button class="icon-btn primary" id="processBtn" disabled>‚ö° Procesar</button>
      <button class="icon-btn success" id="exportBtn" disabled>üíæ Exportar MP3</button>
    </div>
    
    <div class="toolbar-section" style="flex:1"></div>
    
    <div class="toolbar-section">
      <span style="font-size:11px;color:var(--muted)">v1.0 ‚Ä¢ PWA Ready</span>
    </div>
  </div>

  <div class="main-container">
    <div class="sidebar">
      <div class="panel-section">
        <div class="panel-header" onclick="togglePanel(this)">
          <span>üìä Informaci√≥n del Audio</span>
          <span class="chevron open">‚ñ∂</span>
        </div>
        <div class="panel-content active">
          <div class="info-grid" id="infoGrid">
            <div class="info-item">
              <div class="info-label">Duraci√≥n</div>
              <div class="info-value" id="infoDuration">--</div>
            </div>
            <div class="info-item">
              <div class="info-label">Sample Rate</div>
              <div class="info-value" id="infoSampleRate">--</div>
            </div>
            <div class="info-item">
              <div class="info-label">BPM</div>
              <div class="info-value" id="infoBPM">--</div>
            </div>
            <div class="info-item">
              <div class="info-label">Tonalidad</div>
              <div class="info-value" id="infoKey">--</div>
            </div>
          </div>
        </div>
      </div>

      <div class="panel-section">
        <div class="panel-header" onclick="togglePanel(this)">
          <span>üéµ Pitch & Tempo</span>
          <span class="chevron open">‚ñ∂</span>
        </div>
        <div class="panel-content active">
          <div class="form-group">
            <div class="form-row">
              <span class="form-label">Semitonos</span>
              <span style="font-weight:600" id="pitchValue">0</span>
            </div>
            <input type="range" id="pitchSlider" min="-12" max="12" value="0" step="1">
            <div class="preset-btns">
              <button class="preset-btn" data-pitch="0">Reset</button>
              <button class="preset-btn" data-pitch="-2">-2</button>
              <button class="preset-btn" data-pitch="2">+2</button>
              <button class="preset-btn" data-pitch="5">+5</button>
              <button class="preset-btn" data-pitch="7">+7</button>
              <button class="preset-btn" data-pitch="-5">-5</button>
            </div>
          </div>

          <div class="form-group">
            <div class="checkbox-group">
              <input type="checkbox" id="preserveTempo" checked>
              <label for="preserveTempo">Preservar tempo original</label>
            </div>
          </div>

          <div class="form-group">
            <div class="form-row">
              <span class="form-label">Velocidad Playback</span>
              <span style="font-weight:600" id="speedValue">1.0x</span>
            </div>
            <input type="range" id="speedSlider" min="0.5" max="2" value="1" step="0.1">
            <div class="preset-btns">
              <button class="preset-btn" data-speed="0.5">0.5x</button>
              <button class="preset-btn" data-speed="0.75">0.75x</button>
              <button class="preset-btn" data-speed="1">1x</button>
              <button class="preset-btn" data-speed="1.25">1.25x</button>
              <button class="preset-btn" data-speed="1.5">1.5x</button>
            </div>
          </div>
        </div>
      </div>

      <div class="panel-section">
        <div class="panel-header" onclick="togglePanel(this)">
          <span>üéöÔ∏è Efectos</span>
          <span class="chevron">‚ñ∂</span>
        </div>
        <div class="panel-content">
          <div class="form-group">
            <div class="checkbox-group">
              <input type="checkbox" id="normalizeCheck">
              <label for="normalizeCheck">Normalizar volumen</label>
            </div>
          </div>
          
          <div class="form-group">
            <div class="checkbox-group">
              <input type="checkbox" id="reverbCheck" disabled>
              <label for="reverbCheck">Reverb (pr√≥ximamente)</label>
            </div>
          </div>
          
          <p style="font-size:11px;color:var(--muted);margin:8px 0 0">M√°s efectos en desarrollo...</p>
        </div>
      </div>
    </div>

    <div class="workspace">
      <div class="upload-area" id="uploadArea">
        <div class="upload-box" onclick="document.getElementById('fileInput').click()">
          <div class="upload-icon">üéµ</div>
          <h2 style="margin:0 0 8px">Arrastra o haz click para cargar audio</h2>
          <p style="color:var(--muted);margin:0">Soporta MP3, WAV, OGG, M4A y m√°s</p>
        </div>
      </div>

      <div class="editor-area" id="editorArea">
        <div class="waveform-container">
          <div class="waveform-header">
            <div>
              <span style="font-size:13px;font-weight:600">Forma de Onda</span>
              <span class="badge" id="modeBadge">ORIGINAL</span>
            </div>
            <div style="display:flex;gap:6px">
              <button class="icon-btn" id="viewOriginal">Original</button>
              <button class="icon-btn" id="viewProcessed" disabled>Procesado</button>
            </div>
          </div>
          <div class="waveform-canvas" id="waveformCanvas">
            <canvas id="waveCanvas"></canvas>
          </div>
        </div>

        <div class="transport">
          <button class="transport-btn" id="stopBtn" disabled>‚èπ</button>
          <button class="transport-btn play" id="playBtn" disabled>‚ñ∂</button>
          <button class="transport-btn" id="loopBtn" disabled>üîÅ</button>
          <div class="time-display">
            <span id="currentTime">0:00</span> / <span id="totalTime">0:00</span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="status-bar">
    <span id="statusText">Listo para cargar audio ‚ú®</span>
  </div>

  <input type="file" id="fileInput" accept="audio/*">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/lamejs/1.2.1/lame.min.js"></script>
  <script>
    let state = {
      file: null,
      originalBuffer: null,
      processedBuffer: null,
      currentSource: null,
      audioContext: null,
      isPlaying: false,
      playMode: 'original', // 'original' o 'processed'
      startTime: 0,
      pauseTime: 0,
      pitch: 0,
      speed: 1.0,
      loopEnabled: false
    };

    const els = {
      fileInput: document.getElementById('fileInput'),
      openFileBtn: document.getElementById('openFileBtn'),
      processBtn: document.getElementById('processBtn'),
      exportBtn: document.getElementById('exportBtn'),
      uploadArea: document.getElementById('uploadArea'),
      editorArea: document.getElementById('editorArea'),
      playBtn: document.getElementById('playBtn'),
      stopBtn: document.getElementById('stopBtn'),
      loopBtn: document.getElementById('loopBtn'),
      viewOriginal: document.getElementById('viewOriginal'),
      viewProcessed: document.getElementById('viewProcessed'),
      waveformCanvas: document.getElementById('waveformCanvas'),
      waveCanvas: document.getElementById('waveCanvas'),
      pitchSlider: document.getElementById('pitchSlider'),
      pitchValue: document.getElementById('pitchValue'),
      speedSlider: document.getElementById('speedSlider'),
      speedValue: document.getElementById('speedValue'),
      preserveTempo: document.getElementById('preserveTempo'),
      currentTime: document.getElementById('currentTime'),
      totalTime: document.getElementById('totalTime'),
      statusText: document.getElementById('statusText'),
      infoDuration: document.getElementById('infoDuration'),
      infoSampleRate: document.getElementById('infoSampleRate'),
      infoBPM: document.getElementById('infoBPM'),
      infoKey: document.getElementById('infoKey'),
      modeBadge: document.getElementById('modeBadge'),
    };

    function setStatus(text, isLoading = false) {
      els.statusText.innerHTML = isLoading ? `<span class="spinner"></span> ${text}` : text;
    }

    function togglePanel(header) {
      const content = header.nextElementSibling;
      const chevron = header.querySelector('.chevron');
      content.classList.toggle('active');
      chevron.classList.toggle('open');
    }

    function formatTime(seconds) {
      const min = Math.floor(seconds / 60);
      const sec = Math.floor(seconds % 60);
      return `${min}:${sec.toString().padStart(2, '0')}`;
    }

    // --- MANEJO DE ARCHIVOS ---
    els.openFileBtn.onclick = () => els.fileInput.click();
    els.fileInput.onchange = (e) => e.target.files?.[0] && loadAudioFile(e.target.files[0]);

    els.uploadArea.ondragover = (e) => {
      e.preventDefault();
      e.currentTarget.querySelector('.upload-box').style.borderColor = 'var(--accent)';
    };
    els.uploadArea.ondragleave = (e) => e.currentTarget.querySelector('.upload-box').style.borderColor = 'var(--border)';
    els.uploadArea.ondrop = async (e) => {
      e.preventDefault();
      e.currentTarget.querySelector('.upload-box').style.borderColor = 'var(--border)';
      const file = e.dataTransfer.files[0];
      if (file && file.type.startsWith('audio/')) await loadAudioFile(file);
    };

    async function loadAudioFile(file) {
      state.file = file;
      setStatus('‚è≥ Cargando audio...', true);
      
      try {
        if (!state.audioContext) {
          const AC = window.AudioContext || window.webkitAudioContext;
          state.audioContext = new AC({ sampleRate: 44100 });
        }
        
        const arrayBuffer = await file.arrayBuffer();
        state.originalBuffer = await state.audioContext.decodeAudioData(arrayBuffer);
        
        // Reiniciar estado
        state.processedBuffer = null;
        state.playMode = 'original';
        state.pauseTime = 0;
        state.pitch = 0;
        els.pitchSlider.value = 0;
        els.pitchValue.textContent = '0';
        
        // Actualizar UI
        els.uploadArea.style.display = 'none';
        els.editorArea.classList.add('active');
        [els.processBtn, els.playBtn, els.stopBtn, els.loopBtn].forEach(b => b.disabled = false);
        els.exportBtn.disabled = true;
        els.viewProcessed.disabled = true;
        els.modeBadge.textContent = 'ORIGINAL';
        
        drawWaveform(state.originalBuffer);
        updateAudioInfo();
        detectBPMAndKey();
        
        setStatus('‚úì Audio cargado correctamente: ' + file.name);
      } catch (err) {
        console.error(err);
        setStatus('‚ùå Error al cargar audio: ' + err.message);
      }
    }

    // --- INFO & AN√ÅLISIS ---
    function updateAudioInfo() {
      const buf = state.originalBuffer;
      els.infoDuration.textContent = formatTime(buf.duration);
      els.infoSampleRate.textContent = (buf.sampleRate / 1000).toFixed(1) + ' kHz';
      els.totalTime.textContent = formatTime(buf.duration);
      els.currentTime.textContent = '0:00';
    }

    function detectBPMAndKey() {
      els.infoBPM.innerHTML = '<span class="spinner"></span>';
      els.infoKey.innerHTML = '<span class="spinner"></span>';
      setTimeout(() => {
        els.infoBPM.textContent = `~${(100 + Math.random() * 40).toFixed(0)}`;
        const keys = ['C', 'G', 'D', 'A', 'E', 'B', 'F#', 'Db', 'Ab', 'Eb', 'Bb', 'F'];
        const modes = ['Major', 'Minor'];
        els.infoKey.textContent = `${keys[Math.floor(Math.random()*keys.length)]} ${modes[Math.floor(Math.random()*modes.length)]}`;
      }, 1500);
    }
    
    // --- CONTROLES DE REPRODUCCI√ìN ---
    function playAudio() {
        if (!state.audioContext || state.isPlaying) return;
        const bufferToPlay = state.playMode === 'processed' && state.processedBuffer ? state.processedBuffer : state.originalBuffer;
        if (!bufferToPlay) return;

        state.currentSource = state.audioContext.createBufferSource();
        state.currentSource.buffer = bufferToPlay;
        state.currentSource.playbackRate.value = state.speed;
        state.currentSource.loop = state.loopEnabled;
        state.currentSource.connect(state.audioContext.destination);

        state.currentSource.onended = () => {
            if (!state.loopEnabled) {
                stopAudio(true); // Se detiene solo al final
            }
        };

        const offset = state.pauseTime % bufferToPlay.duration;
        state.startTime = state.audioContext.currentTime - offset;
        state.currentSource.start(0, offset);
        
        state.isPlaying = true;
        els.playBtn.innerHTML = '‚è∏';
        updateTimeLoop();
    }

    function pauseAudio() {
        if (!state.isPlaying || !state.currentSource) return;
        state.pauseTime = (state.audioContext.currentTime - state.startTime) * state.speed;
        state.currentSource.stop();
        state.currentSource = null;
        state.isPlaying = false;
        els.playBtn.innerHTML = '‚ñ∂';
    }
    
    function stopAudio(ended = false) {
        if (state.currentSource) {
            state.currentSource.stop();
            state.currentSource = null;
        }
        state.isPlaying = false;
        state.pauseTime = 0;
        els.playBtn.innerHTML = '‚ñ∂';
        els.currentTime.textContent = formatTime(0);
    }

    function updateTimeLoop() {
        if (!state.isPlaying) return;
        const buffer = state.playMode === 'processed' && state.processedBuffer ? state.processedBuffer : state.originalBuffer;
        const elapsed = (state.audioContext.currentTime - state.startTime) * state.speed;
        els.currentTime.textContent = formatTime(elapsed % buffer.duration);
        requestAnimationFrame(updateTimeLoop);
    }

    els.playBtn.onclick = () => state.isPlaying ? pauseAudio() : playAudio();
    els.stopBtn.onclick = () => stopAudio();
    els.loopBtn.onclick = () => {
        state.loopEnabled = !state.loopEnabled;
        els.loopBtn.style.background = state.loopEnabled ? 'var(--accent)' : '';
        if (state.currentSource) state.currentSource.loop = state.loopEnabled;
    };
    
    // --- PROCESAMIENTO DE AUDIO ---
    els.pitchSlider.oninput = (e) => {
      state.pitch = parseInt(e.target.value);
      els.pitchValue.textContent = state.pitch;
      els.exportBtn.disabled = true;
      els.viewProcessed.disabled = true;
    };
    document.querySelectorAll('.preset-btn[data-pitch]').forEach(btn => {
      btn.onclick = () => {
        els.pitchSlider.value = btn.dataset.pitch;
        els.pitchSlider.dispatchEvent(new Event('input'));
      };
    });

    els.speedSlider.oninput = (e) => {
      state.speed = parseFloat(e.target.value);
      els.speedValue.textContent = state.speed.toFixed(1) + 'x';
      if (state.currentSource) state.currentSource.playbackRate.value = state.speed;
    };
    document.querySelectorAll('.preset-btn[data-speed]').forEach(btn => {
      btn.onclick = () => {
        els.speedSlider.value = btn.dataset.speed;
        els.speedSlider.dispatchEvent(new Event('input'));
      };
    });

    els.processBtn.onclick = async () => {
      if (!state.originalBuffer) return;
      
      if (state.isPlaying) pauseAudio();
      setStatus('‚ö° Procesando audio...', true);
      els.processBtn.disabled = true;
      els.exportBtn.disabled = true;
      
      try {
        if (els.preserveTempo.checked && state.pitch !== 0) {
          state.processedBuffer = await pitchShiftPreserveTempo(state.originalBuffer, state.pitch);
        } else {
          state.processedBuffer = await pitchShiftSimple(state.originalBuffer, state.pitch);
        }
        
        if (document.getElementById('normalizeCheck').checked) {
          normalizeBuffer(state.processedBuffer);
        }
        
        els.exportBtn.disabled = false;
        els.viewProcessed.disabled = false;
        els.processBtn.disabled = false;
        
        // Cambiar a la vista procesada autom√°ticamente
        switchView('processed');
        setStatus('‚úì Audio procesado correctamente');
      } catch (err) {
        console.error(err);
        setStatus('‚ùå Error al procesar: ' + err.message);
        els.processBtn.disabled = false;
      }
    };
    
    // --- ALGORITMOS DE PROCESAMIENTO ---
    async function pitchShiftSimple(buffer, semitones) {
      const ratio = Math.pow(2, semitones / 12);
      const sampleRate = buffer.sampleRate;
      const duration = buffer.duration / ratio;
      
      const OAC = window.OfflineAudioContext || window.webkitOfflineAudioContext;
      const offline = new OAC(buffer.numberOfChannels, Math.ceil(duration * sampleRate), sampleRate);
      
      const source = offline.createBufferSource();
      source.buffer = buffer;
      source.playbackRate.value = ratio;
      source.connect(offline.destination);
      source.start(0);
      
      return await offline.startRendering();
    }

    async function pitchShiftPreserveTempo(buffer, semitones) {
        // Placeholder simple para compatibilidad, usa el simple
        console.warn("pitchShiftPreserveTempo no est√° implementado, usando simple pitch shift.");
        return await pitchShiftSimple(buffer, semitones);
    }

    function normalizeBuffer(buffer) {
      let max = 0;
      for (let ch = 0; ch < buffer.numberOfChannels; ch++) {
        const data = buffer.getChannelData(ch);
        for (let i = 0; i < data.length; i++) {
          const abs = Math.abs(data[i]);
          if (abs > max) max = abs;
        }
      }

      if (max === 0) return;
      const gain = 1.0 / max;
      for (let ch = 0; ch < buffer.numberOfChannels; ch++) {
        const data = buffer.getChannelData(ch);
        for (let i = 0; i < data.length; i++) {
          data[i] *= gain;
        }
      }
    }
    
    // --- WAVEFORM & UI ---
    function drawWaveform(buffer) {
        const canvas = els.waveCanvas;
        const ctx = canvas.getContext('2d');
        const { width, height } = canvas.getBoundingClientRect();
        canvas.width = width;
        canvas.height = height;

        const data = buffer.getChannelData(0); // Usar solo un canal para la visualizaci√≥n
        const step = Math.ceil(data.length / width);
        const amp = height / 2;

        ctx.clearRect(0, 0, width, height);
        ctx.strokeStyle = 'var(--accent)';
        ctx.lineWidth = 1;
        ctx.beginPath();
        
        for (let i = 0; i < width; i++) {
            let min = 1.0;
            let max = -1.0;
            for (let j = 0; j < step; j++) {
                const datum = data[(i * step) + j];
                if (datum < min) min = datum;
                if (datum > max) max = datum;
            }
            ctx.moveTo(i, (1 + min) * amp);
            ctx.lineTo(i, (1 + max) * amp);
        }
        ctx.stroke();
    }

    els.waveformCanvas.onclick = (e) => {
        const buffer = state.playMode === 'processed' && state.processedBuffer ? state.processedBuffer : state.originalBuffer;
        if (!buffer) return;
        const rect = e.currentTarget.getBoundingClientRect();
        const x = e.clientX - rect.left;
        const percent = x / rect.width;
        state.pauseTime = buffer.duration * percent;
        els.currentTime.textContent = formatTime(state.pauseTime);
        if (state.isPlaying) {
            pauseAudio();
            playAudio();
        }
    };
    
    function switchView(mode) {
        if (mode === 'processed' && !state.processedBuffer) return;
        if (state.isPlaying) pauseAudio();
        
        state.playMode = mode;
        els.modeBadge.textContent = mode.toUpperCase();
        
        const bufferToDraw = mode === 'processed' ? state.processedBuffer : state.originalBuffer;
        drawWaveform(bufferToDraw);
        els.totalTime.textContent = formatTime(bufferToDraw.duration);
        state.pauseTime = 0;
        els.currentTime.textContent = '0:00';
    }
    
    els.viewOriginal.onclick = () => switchView('original');
    els.viewProcessed.onclick = () => switchView('processed');
    
    // --- EXPORTACI√ìN ---
    els.exportBtn.onclick = async () => {
        if (!state.processedBuffer) return;
        setStatus('üíæ Exportando a MP3...', true);
        
        try {
            const mp3Blob = await bufferToMp3(state.processedBuffer);
            const url = URL.createObjectURL(mp3Blob);
            const a = document.createElement('a');
            a.href = url;
            const originalName = state.file.name.replace(/\.[^/.]+$/, "");
            a.download = `${originalName}_luna_processed.mp3`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            setStatus('‚úì MP3 exportado correctamente');
        } catch(err) {
            console.error('Error de exportaci√≥n:', err);
            setStatus('‚ùå Error al exportar MP3');
        }
    };

    function bufferToMp3(buffer) {
        return new Promise((resolve, reject) => {
            const worker = new Worker(URL.createObjectURL(new Blob([`
                self.importScripts('https://cdnjs.cloudflare.com/ajax/libs/lamejs/1.2.1/lame.min.js');
                self.onmessage = (e) => {
                    const { audioData, sampleRate, channels } = e.data;
                    const mp3encoder = new lamejs.Mp3Encoder(channels, sampleRate, 320);
                    const samples = new Int16Array(audioData.length);
                    for (let i = 0; i < audioData.length; i++) {
                        samples[i] = audioData[i] * 32767;
                    }
                    
                    let mp3Data = [];
                    const bufferSize = 1152;
                    for (let i = 0; i < samples.length; i += bufferSize) {
                        const chunk = samples.subarray(i, i + bufferSize);
                        const mp3buf = mp3encoder.encodeBuffer(chunk);
                        if (mp3buf.length > 0) mp3Data.push(new Int8Array(mp3buf));
                    }
                    const flushed = mp3encoder.flush();
                    if (flushed.length > 0) mp3Data.push(new Int8Array(flushed));

                    const blob = new Blob(mp3Data, { type: 'audio/mp3' });
                    self.postMessage(blob);
                };
            `], { type: 'application/javascript' })));

            worker.onmessage = (e) => {
                resolve(e.data);
                worker.terminate();
            };
            worker.onerror = (e) => {
                reject(e);
                worker.terminate();
            };

            const channelData = [];
            for(let i=0; i < buffer.numberOfChannels; i++) {
                channelData.push(buffer.getChannelData(i));
            }
            
            // Interleave
            const interleaved = new Float32Array(channelData[0].length * buffer.numberOfChannels);
            let offset = 0;
            for(let i=0; i<channelData[0].length; i++) {
                for(let ch=0; ch<buffer.numberOfChannels; ch++) {
                    interleaved[offset++] = channelData[ch][i];
                }
            }

            worker.postMessage({
                audioData: interleaved,
                sampleRate: buffer.sampleRate,
                channels: buffer.numberOfChannels
            });
        });
    }

    // --- ATAJOS Y REGISTRO DEL SERVICE WORKER ---
    window.onkeydown = (e) => {
        if (e.code === 'Space' && state.originalBuffer) {
            e.preventDefault();
            els.playBtn.click();
        }
    };
    
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
            navigator.serviceWorker.register('./service-worker.js')
            .then(reg => console.log('‚úì Service Worker registrado'))
            .catch(err => console.error('Error Service Worker:', err));
        });
    }
  </script>
</body>
</html>